name: Code Coverage

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  coverage:
    # This job serves as the Ubuntu test runner AND coverage generator.
    # Coverage runs the same tests as cargo test, just with LLVM instrumentation.
    # macOS/Windows testing is handled separately in test.yml.
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust
        with:
          components: llvm-tools-preview

      - uses: ./.github/actions/install-tools
        with:
          tools: just,cargo-llvm-cov,cargo-nextest

      - name: Run tests with coverage
        run: just test-coverage

      - name: Upload to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # ratchet:codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Archive coverage artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # ratchet:actions/upload-artifact@v6
        with:
          name: coverage-report
          path: lcov.info

name: Test
on:
  workflow_dispatch:
    inputs:
      extended_platforms:
        description: 'Run extended platform testing'
        type: boolean
        required: false
        default: false
  push:
    branches:
      - main
      - dev
jobs:
  test-platforms:
    # NOTE: Ubuntu testing is handled by coverage.yml which runs the same tests
    # with LLVM instrumentation. This avoids duplicate builds while still
    # ensuring cross-platform compatibility on macOS and Windows.
    name: Test Rust ${{ matrix.rust }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - {rust: stable, os: macos-latest}
          - {rust: stable, os: windows-latest}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # ratchet:actions/checkout@v4

      - uses: ./.github/actions/setup-rust
        with:
          toolchain: ${{ matrix.rust }}

      - run: cargo test --verbose --workspace --all-features
      - run: cargo test --verbose --workspace --no-default-features

  test-extended-platforms:
    name: Extended Test - ${{ matrix.rust }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.extended_platforms == 'true' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - {rust: stable-x86_64-gnu, os: windows-latest}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # ratchet:actions/checkout@v4

      - uses: ./.github/actions/setup-rust
        with:
          toolchain: ${{ matrix.rust }}

      - run: cargo test --verbose --workspace --all-features
      - run: cargo test --verbose --workspace --no-default-features

  cross-test:
    name: Cross Test - ${{ matrix.target }}
    runs-on: ubuntu-latest
    if: github.event.inputs.extended_platforms == 'true'
    strategy:
      fail-fast: false
      matrix:
        target:
          # ARM targets - most relevant for CLI tools
          - aarch64-unknown-linux-gnu
          - armv7-unknown-linux-gnueabihf
          # 32-bit x86
          - i686-unknown-linux-gnu
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # ratchet:actions/checkout@v4

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          tool: cross

      - run: cross test --verbose --target=${{ matrix.target }} --no-default-features
      - run: cross test --verbose --target=${{ matrix.target }} --all-features

  checks:
    name: Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # ratchet:actions/checkout@v4

      - uses: ./.github/actions/setup-rust
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Check documentation
        env:
          RUSTDOCFLAGS: -D warnings
        run: cargo doc --no-deps --document-private-items --workspace

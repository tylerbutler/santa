name: PR Validation
on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust
        with:
          components: rustfmt

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Install ruff
        uses: astral-sh/ruff-action@4919ec5cf1f49eff0871dbcea0da843445b837e6 # ratchet:astral-sh/ruff-action@v3
        with:
          args: "--version"

      - name: Check formatting
        run: just format --check

      - name: Check documentation
        run: just docs-check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust
        with:
          components: clippy

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Clippy check
        run: just lint

  build:
    name: Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Debug build
        run: just build

      - name: Verify package
        # Skip for release-plz PRs - bumped workspace deps won't exist on crates.io yet
        if: ${{ !startsWith(github.head_ref, 'release-plz-') }}
        run: just verify-package

      - name: Check for unexpected changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Unexpected changes detected after build:"
            git status --short
            git diff
            exit 1
          fi

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          # cargo-deny 0.18.6+ required for CVSS 4.0 support
          tools: just,cargo-audit,cargo-deny@0.18.9

      - name: Security audit
        run: just audit

  semver:
    name: Semver Check (Informational)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          fetch-depth: 0 # Required for cargo-semver-checks

      - name: Get merge base
        id: merge-base
        run: |
          # Find the merge base between this PR and main
          MERGE_BASE=$(git merge-base origin/main HEAD)
          echo "sha=$MERGE_BASE" >> "$GITHUB_OUTPUT"
          echo "Comparing against merge base: $MERGE_BASE"

      - name: Check semver compatibility
        id: semver
        continue-on-error: true
        uses: obi1kenobi/cargo-semver-checks-action@5b298c9520f7096a4683c0bd981a7ac5a7e249ae # ratchet:obi1kenobi/cargo-semver-checks-action@v2
        with:
          baseline-rev: ${{ steps.merge-base.outputs.sha }}

      - name: Set output for comment
        id: result
        run: |
          echo "has_breaking=${{ steps.semver.outcome == 'failure' }}" >> "$GITHUB_OUTPUT"

      - name: Comment on PR with breaking changes
        if: steps.result.outputs.has_breaking == 'true'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2
        with:
          header: semver-check
          message: |
            ## ‚ö†Ô∏è Semver Breaking Changes Detected

            This PR introduces API changes that may be semver-incompatible (compared to main branch).

            Check the workflow logs for details on what changed.

            <details>
            <summary>What does this mean?</summary>

            These changes may break downstream users if released as a patch or minor version.
            Consider whether a major version bump is needed, or if the changes can be made backwards-compatible.
            </details>

      - name: Remove comment if no breaking changes
        if: steps.result.outputs.has_breaking == 'false'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2
        with:
          header: semver-check
          delete: true

  workspace-consistency:
    name: Workspace Consistency
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust

      - name: Check for duplicate dependencies
        run: |
          echo "Checking for duplicate dependencies across workspace..."
          cargo tree --duplicates --workspace || echo "No duplicates found"

      - name: Verify dependency tree
        run: |
          echo "Analyzing santa-data dependencies..."
          cargo tree --edges normal --invert santa-data
          echo "Analyzing sickle dependencies..."
          cargo tree --edges normal --invert sickle
          echo "Analyzing santa-cli dependencies..."
          cargo tree -p santa --depth 3

  binary-size:
    name: Binary Size (Informational)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout PR
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust

      - name: Build PR release binary
        run: cargo build --release

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Get PR binary size
        id: pr-size
        run: |
          SIZE=$(just binary-size target/release/santa)
          echo "bytes=$SIZE" >> "$GITHUB_OUTPUT"
          echo "PR binary size: $SIZE bytes"

      - name: Checkout main branch
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          ref: main
          clean: false

      - name: Build main release binary
        run: |
          # Clean previous build to ensure fresh main build
          cargo clean -p santa
          cargo build --release

      - name: Get main binary size
        id: main-size
        run: |
          SIZE=$(just binary-size target/release/santa)
          echo "bytes=$SIZE" >> "$GITHUB_OUTPUT"
          echo "Main binary size: $SIZE bytes"

      - name: Restore PR checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          clean: false

      - name: Calculate size difference
        id: diff
        env:
          PR_SIZE: ${{ steps.pr-size.outputs.bytes }}
          MAIN_SIZE: ${{ steps.main-size.outputs.bytes }}
        run: just binary-size-compare "$PR_SIZE" "$MAIN_SIZE"

      - name: Comment on PR with size change
        if: steps.diff.outputs.significant == 'true'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2
        with:
          header: binary-size
          message: |
            ## üì¶ Binary Size Change

            | Metric | Value |
            |--------|-------|
            | This PR | ${{ steps.diff.outputs.pr_size }} |
            | main | ${{ steps.diff.outputs.main_size }} |
            | Change | ${{ steps.diff.outputs.diff }} (${{ steps.diff.outputs.percent }}) |

            <details>
            <summary>What does this mean?</summary>

            Binary size increased significantly. This may be expected for new features,
            but consider reviewing if the change seems disproportionate to the code changes.

            Common causes: new dependencies, removed LTO/stripping, debug symbols, large static data.
            </details>

      - name: Remove size comment if not significant
        if: steps.diff.outputs.significant == 'false'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2
        with:
          header: binary-size
          delete: true

  package-isolation:
    name: Package Isolation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6

      - uses: ./.github/actions/setup-rust

      - name: Test packages in isolation
        run: |
          echo "Testing santa-cli in isolation..."
          cargo test -p santa --no-fail-fast
          echo "Testing santa-data in isolation..."
          cargo test -p santa-data --no-fail-fast
          echo "Testing sickle in isolation..."
          cargo test -p sickle --no-fail-fast

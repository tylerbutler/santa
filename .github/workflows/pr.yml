name: PR Validation
on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust
        with:
          components: rustfmt

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Check formatting
        run: just format --check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust
        with:
          components: clippy

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Clippy check
        run: just lint

  build:
    name: Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          tools: just

      - name: Debug build
        run: just build

      - name: Verify package
        run: just verify-package

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          tools: just,cargo-audit,cargo-deny

      - name: Security audit
        run: just audit

  semver:
    name: Semver Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5
        with:
          fetch-depth: 0 # Required for cargo-semver-checks

      - uses: ./.github/actions/setup-rust

      - uses: ./.github/actions/install-tools
        with:
          tools: just,cargo-semver-checks

      - name: Check semver compatibility
        run: just semver

  workspace-consistency:
    name: Workspace Consistency
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust

      - name: Check for duplicate dependencies
        run: |
          echo "Checking for duplicate dependencies across workspace..."
          cargo tree --duplicates --workspace || echo "No duplicates found"

      - name: Verify dependency tree
        run: |
          echo "Analyzing santa-data dependencies..."
          cargo tree --edges normal --invert santa-data
          echo "Analyzing sickle dependencies..."
          cargo tree --edges normal --invert sickle
          echo "Analyzing santa-cli dependencies..."
          cargo tree -p santa --depth 3

  package-isolation:
    name: Package Isolation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5

      - uses: ./.github/actions/setup-rust

      - name: Test packages in isolation
        run: |
          echo "Testing santa-cli in isolation..."
          cargo test -p santa --no-fail-fast
          echo "Testing santa-data in isolation..."
          cargo test -p santa-data --no-fail-fast
          echo "Testing sickle in isolation..."
          cargo test -p sickle --no-fail-fast
